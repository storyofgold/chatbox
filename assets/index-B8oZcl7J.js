(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))n(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const i of t.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function a(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function n(e){if(e.ep)return;e.ep=!0;const t=a(e);fetch(e.href,t)}})();const j={x:1.3,y:5.1,width:94,height:80.1},I="--- ANNOTATIONS ---",_="https://vigorously-fun-yak.ngrok-free.app/query",G=p=>new Promise((s,a)=>{const n=new FileReader;n.onloadend=()=>s(n.result.split(",")[1]),n.onerror=a,n.readAsDataURL(p)}),q=async p=>{const s=await fetch(_,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});if(!s.ok){const n=await s.text();throw new Error(`Backend request failed with status ${s.status}: ${n}`)}const a=await s.json();if(!a.responseText)throw new Error("Invalid response from backend: 'responseText' field is missing.");return a.responseText},z=p=>{if(!p)return[];const s=p.split(`
`).map(n=>n.trim()).filter(Boolean),a=[];for(const n of s)try{if(n.toUpperCase().startsWith("LINE:")){const e=/x1=([\d.]+).*y1=([\d.]+).*x2=([\d.]+).*y2=([\d.]+).*color=([^,]+).*strokeWidth=([\d.]+)/i.exec(n);e&&a.push({type:"line",x1:+e[1],y1:+e[2],x2:+e[3],y2:+e[4],color:e[5].trim(),strokeWidth:+e[6]||.3})}else if(n.toUpperCase().startsWith("RECT:")){const e=/x=([\d.]+).*y=([\d.]+).*width=([\d.]+).*height=([\d.]+).*color=([^,]+).*fillOpacity=([\d.]+)/i.exec(n);e&&a.push({type:"rect",x:+e[1],y:+e[2],width:+e[3],height:+e[4],color:e[5].trim(),fillOpacity:+e[6]||.2})}else if(n.toUpperCase().startsWith("TEXT:")){const e=/x=([\d.]+).*y=([\d.]+).*text=\"([^\"]+)\".*color=([^,]+).*fontSize=([\d.]+)/i.exec(n);e&&a.push({type:"text",x:+e[1],y:+e[2],text:e[3],color:e[4].trim(),fontSize:+e[5]||1.5})}}catch(e){console.error("Failed to parse annotation line:",n,e)}return a},W=(p,s,a)=>{p.innerHTML="";const n=document.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("transform",`translate(${a.x} ${a.y}) scale(${a.width/100} ${a.height/100})`),s.forEach(e=>{let t;e.type==="line"?(t=document.createElementNS("http://www.w3.org/2000/svg","line"),t.setAttribute("x1",String(e.x1)),t.setAttribute("y1",String(e.y1)),t.setAttribute("x2",String(e.x2)),t.setAttribute("y2",String(e.y2)),t.setAttribute("stroke",e.color||"#ffffff"),t.setAttribute("stroke-width",String(e.strokeWidth))):e.type==="rect"?(t=document.createElementNS("http://www.w3.org/2000/svg","rect"),t.setAttribute("x",String(e.x)),t.setAttribute("y",String(e.y)),t.setAttribute("width",String(e.width)),t.setAttribute("height",String(e.height)),t.setAttribute("fill",e.color||"#ffffff"),t.setAttribute("fill-opacity",String(e.fillOpacity))):e.type==="text"&&(t=document.createElementNS("http://www.w3.org/2000/svg","text"),t.setAttribute("x",String(e.x)),t.setAttribute("y",String(e.y)),t.setAttribute("fill",e.color||"#ffffff"),t.setAttribute("font-size",String(e.fontSize)),t.textContent=e.text),t&&n.appendChild(t)}),p.appendChild(n)},F=p=>p.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^\s*-\s+(.*)/gm,"<li>$1</li>").replace(/(<\/li>\n<li>)/g,"</li><li>").replace(/<li>.*<\/li>/gs,a=>`<ul>${a}</ul>`).replace(/\n/g,"<br>").replace(/<br>\s*<ul>/g,"<ul>").replace(/<\/ul>\s*<br>/g,"</ul>");document.addEventListener("DOMContentLoaded",()=>{const p=document.getElementById("analysis-form"),s=document.getElementById("chart-upload"),a=document.getElementById("upload-button"),n=document.getElementById("file-name-display"),e=document.getElementById("user-query-input"),t=document.getElementById("analyze-button"),i=document.getElementById("analysis-history"),P=document.querySelector(".placeholder");let S=null,v=[];if(!p||!s||!a||!n||!e||!t||!i){console.warn("One or more analysis panel elements are not found in the DOM.");return}const A=()=>{const d=e.value.trim().length>0;t.disabled=!d||!S&&v.length===0},k=d=>{d&&d.type.startsWith("image/")?(S=d,n.textContent=d.name,a.classList.add("file-selected")):(S=null,n.textContent="",a.classList.remove("file-selected"),d&&alert("Please select an image file (e.g., PNG, JPG).")),A()},U=async(d,w)=>{const l=d.currentTarget.closest(".analysis-entry"),{query:E,imageData:y,imageMime:c,imageName:N,analysisText:m}=l.dataset;if(!y||!c)return;const o=l.querySelector(".entry-content"),x=l.querySelector(".annotation-overlay"),u=document.createElement("div");u.className="loader";const b=o.innerHTML;if(w==="full")o.innerHTML="",o.appendChild(u);else{const r=l.querySelector(".image-container");r?r.insertAdjacentElement("beforebegin",u):o.insertAdjacentElement("afterbegin",u)}try{let r,g;if(w==="full"){if(!E)throw new Error("Original query not found for full refresh.");g={query:E,image:{mimeType:c,data:y}},v=[]}else{if(!m)throw new Error("Cannot refresh annotations: original analysis text not found.");g={mode:"refresh_annotations",existingAnalysis:m,image:{mimeType:c,data:y}}}if(r=await q(g),w==="full"){const h={role:"user",parts:[{inlineData:{mimeType:c,data:y}},{text:E}]},L={role:"model",parts:[{text:r}]};v.push(h,L),A()}if(!r)throw new Error("Received an empty response from the API.");const f=r.indexOf(I);let C=r,M="";if(f!==-1)C=r.substring(0,f).trim(),M=r.substring(f+I.length).trim();else if(w==="annotations"){const h=r.toUpperCase().indexOf("RECT:");h!==-1&&(M=r.substring(h).trim())}const O=z(M);if(W(x,O,j),w==="full"){l.dataset.analysisText=C;const h=document.createElement("div");h.className="image-container",h.innerHTML=`<img src="data:${c};base64,${y}" alt="Chart for ${N}">`,h.appendChild(x);const L=document.createElement("div");L.className="analysis-text",L.innerHTML=F(C),o.innerHTML="",o.appendChild(h),o.appendChild(L)}else u.remove()}catch(r){console.error("Refresh error:",r),o.innerHTML=b;const g=document.createElement("p");g.className="error-message",g.textContent=`Failed to refresh: ${r instanceof Error?r.message:String(r)}`,o.prepend(g),w==="full"&&(v=[],A())}};a.addEventListener("click",()=>s.click()),s.addEventListener("change",()=>k(s.files?s.files[0]:null)),e.addEventListener("input",()=>{A(),e.style.height="auto",e.style.height=`${e.scrollHeight}px`}),i.addEventListener("dragover",d=>{d.preventDefault(),i.classList.add("drag-over")}),i.addEventListener("dragleave",d=>{d.preventDefault(),i.classList.remove("drag-over")}),i.addEventListener("drop",d=>{var T,l;d.preventDefault(),i.classList.remove("drag-over");const w=(l=(T=d.dataTransfer)==null?void 0:T.files)==null?void 0:l[0];w&&(s.files=d.dataTransfer.files,k(w))}),p.addEventListener("submit",async d=>{d.preventDefault();const w=e.value.trim();if(w){if(P&&(P.style.display="none"),S){const T=S,l=document.createElement("div");l.className="analysis-entry";const E=document.createElement("header");E.className="entry-header";const y=document.createElement("span");y.className="query-title",y.textContent=`Query for ${T.name}: "${w}"`,E.appendChild(y);const c=document.createElement("div");c.className="entry-content";const N=document.createElement("div");N.className="loader",c.appendChild(N),l.append(E,c),i.appendChild(l),i.scrollTop=i.scrollHeight;const m=S,o=e.value;k(null),s.value="",e.value="",e.style.height="auto",A();try{const x=await G(m);l.dataset.query=o,l.dataset.imageData=x,l.dataset.imageMime=m.type,l.dataset.imageName=m.name;const u=document.createElement("div");u.className="entry-actions";const b=document.createElement("button");b.className="entry-action-button",b.title="Refresh Full Analysis",b.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>',b.onclick=R=>U(R,"full");const r=document.createElement("button");r.className="entry-action-button",r.title="Refresh Annotations Only",r.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>',r.onclick=R=>U(R,"annotations"),u.append(b,r),E.appendChild(u),v=[];const g={query:o,image:{mimeType:m.type,data:x}},f=await q(g),C={role:"user",parts:[{inlineData:{mimeType:m.type,data:x}},{text:o}]},M={role:"model",parts:[{text:f}]};if(v.push(C,M),!f)throw new Error("Received an empty response from the API.");const O=f.indexOf(I);let h=f,L="";O!==-1&&(h=f.substring(0,O).trim(),L=f.substring(O+I.length).trim()),l.dataset.analysisText=h;const B=document.createElement("div");B.className="image-container";const D=document.createElement("img");D.src=URL.createObjectURL(m),D.alt="Uploaded chart for analysis";const H=document.createElementNS("http://www.w3.org/2000/svg","svg");H.setAttribute("class","annotation-overlay"),H.setAttribute("viewBox","0 0 100 100"),H.setAttribute("preserveAspectRatio","none");const Q=z(L);W(H,Q,j),B.append(D,H);const $=document.createElement("div");$.className="analysis-text",$.innerHTML=F(h),c.innerHTML="",c.append(B,$)}catch(x){v=[],console.error("Analysis error:",x);const u=document.createElement("div");u.className="analysis-text",u.innerHTML='<p class="error-message">Failed to get analysis. Please check the console for more details.</p>',x instanceof Error&&(u.innerHTML+=`<p class="error-details">${x.message}</p>`),c.innerHTML="",c.appendChild(u)}finally{i.scrollTop=i.scrollHeight,A()}}else if(v.length>0){const T=e.value.trim(),l=document.createElement("div");l.className="analysis-entry follow-up-entry";const E=document.createElement("header");E.className="entry-header";const y=document.createElement("span");y.className="query-title",y.textContent=`Follow-up: "${T}"`,E.appendChild(y);const c=document.createElement("div");c.className="entry-content";const N=document.createElement("div");N.className="loader",c.appendChild(N),l.append(E,c),i.appendChild(l),i.scrollTop=i.scrollHeight,e.value="",e.style.height="auto",A();try{const m=v.find(f=>f.role==="user"&&f.parts.some(C=>"inlineData"in C)),o=m==null?void 0:m.parts.find(f=>"inlineData"in f);if(!o)throw new Error("Original image not found in history. Cannot send follow-up.");const x={query:T,image:{mimeType:o.inlineData.mimeType,data:o.inlineData.data}},u=await q(x),b={role:"user",parts:[{text:T}]},r={role:"model",parts:[{text:u}]};v.push(b,r);const g=document.createElement("div");g.className="analysis-text",g.innerHTML=F(u),c.innerHTML="",c.appendChild(g)}catch(m){console.error("Follow-up error:",m);const o=document.createElement("div");o.className="analysis-text",o.innerHTML='<p class="error-message">Failed to get follow-up response.</p>',m instanceof Error&&(o.innerHTML+=`<p class="error-details">${m.message}</p>`),c.innerHTML="",c.appendChild(o)}finally{i.scrollTop=i.scrollHeight}}}})});
